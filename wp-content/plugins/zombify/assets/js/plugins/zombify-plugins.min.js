!function(e){e.fn.caret=function(e){var t=this[0],i="true"===t.contentEditable;if(0==arguments.length){if(window.getSelection){if(i){t.focus();var a=window.getSelection().getRangeAt(0),n=a.cloneRange();return n.selectNodeContents(t),n.setEnd(a.endContainer,a.endOffset),n.toString().length}return t.selectionStart}if(document.selection){if(t.focus(),i){var a=document.selection.createRange(),n=document.body.createTextRange();return n.moveToElementText(t),n.setEndPoint("EndToEnd",a),n.text.length}var e=0,r=t.createTextRange(),n=document.selection.createRange().duplicate(),o=n.getBookmark();for(r.moveToBookmark(o);0!==r.moveStart("character",-1);)e++;return e}return t.selectionStart?t.selectionStart:0}if(-1==e&&(e=this[i?"text":"val"]().length),window.getSelection)i?(t.focus(),window.getSelection().collapse(t.firstChild,e)):t.setSelectionRange(e,e);else if(document.body.createTextRange)if(i){var r=document.body.createTextRange();r.moveToElementText(t),r.moveStart("character",e),r.collapse(!0),r.select()}else{var r=t.createTextRange();r.move("character",e),r.select()}return i||t.focus(),e}}(jQuery),!function(e){e.fn.tagEditorInput=function(){var t=" ",i=e(this),a=parseInt(i.css("fontSize")),n=e("<span/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:i.css("fontSize"),fontFamily:i.css("fontFamily"),fontWeight:i.css("fontWeight"),letterSpacing:i.css("letterSpacing"),whiteSpace:"nowrap"}),r=function(){if(t!==(t=i.val())){n.text(t);var e=n.width()+a;20>e&&(e=20),e!=i.width()&&i.width(e)}};return n.insertAfter(i),i.bind("keyup keydown focus",r)},e.fn.tagEditor=function(t,a,n){function r(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}var o,l=e.extend({},e.fn.tagEditor.defaults,t),c=this;if(l.dregex=new RegExp("["+l.delimiter.replace("-","-")+"]","g"),"string"==typeof t){var s=[];return c.each(function(){var i=e(this),r=i.data("options"),o=i.next(".tag-editor");if("getTags"==t)s.push({field:i[0],editor:o,tags:o.data("tags")});else if("addTag"==t){if(r.maxTags&&o.data("tags").length>=r.maxTags)return!1;e('<li><div class="tag-editor-spacer">&nbsp;'+r.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>').appendTo(o).find(".tag-editor-tag").html('<input type="text" maxlength="'+r.maxLength+'">').addClass("active").find("input").val(a).blur(),n?e(".placeholder",o).remove():o.click()}else"removeTag"==t?(e(".tag-editor-tag",o).filter(function(){return e(this).text()==a}).closest("li").find(".tag-editor-delete").click(),n||o.click()):"destroy"==t&&i.removeClass("tag-editor-hidden-src").removeData("options").off("focus.tag-editor").next(".tag-editor").remove()}),"getTags"==t?s:this}return window.getSelection&&e(document).off("keydown.tag-editor").on("keydown.tag-editor",function(t){if(8==t.which||46==t.which||t.ctrlKey&&88==t.which){try{var a=getSelection(),n="BODY"==document.activeElement.tagName?e(a.getRangeAt(0).startContainer.parentNode).closest(".tag-editor"):0}catch(t){n=0}if(a.rangeCount>0&&n&&n.length){var r=[],o=a.toString().split(n.prev().data("options").dregex);for(i=0;i<o.length;i++){var l=e.trim(o[i]);l&&r.push(l)}return e(".tag-editor-tag",n).each(function(){~e.inArray(e(this).text(),r)&&e(this).closest("li").find(".tag-editor-delete").click()}),!1}}}),c.each(function(){function t(){!l.placeholder||c.length||e(".deleted, .placeholder, input",s).length||s.append('<li class="placeholder"><div>'+l.placeholder+"</div></li>")}function i(i){var a=c.toString();c=e(".tag-editor-tag:not(.deleted)",s).map(function(t,i){var a=e.trim(e(this).hasClass("active")?e(this).find("input").val():e(i).text());return a?a:void 0}).get(),s.data("tags",c),n.val(c.join(l.delimiter[0])),i||a!=c.toString()&&l.onChange(n,s,c),t()}function a(t){for(var a,o=t.closest("li"),d=t.val().replace(/ +/," ").split(l.dregex),g=t.data("old_tag"),f=c.slice(0),u=!1,h=0;h<d.length;h++)if(v=e.trim(d[h]).slice(0,l.maxLength),l.forceLowercase&&(v=v.toLowerCase()),a=l.beforeTagSave(n,s,f,g,v),v=a||v,a!==!1&&v&&(l.removeDuplicates&&~e.inArray(v,f)&&e(".tag-editor-tag",s).each(function(){e(this).text()==v&&e(this).closest("li").remove()}),f.push(v),o.before('<li><div class="tag-editor-spacer">&nbsp;'+l.delimiter[0]+'</div><div class="tag-editor-tag">'+r(v)+'</div><div class="tag-editor-delete"><i></i></div></li>'),l.maxTags&&f.length>=l.maxTags)){u=!0;break}t.attr("maxlength",l.maxLength).removeData("old_tag").val(""),u?t.blur():t.focus(),i()}var n=e(this),c=[],s=e("<ul "+(l.clickDelete?'oncontextmenu="return false;" ':"")+'class="tag-editor"></ul>').insertAfter(n);n.addClass("tag-editor-hidden-src").data("options",l).on("focus.tag-editor",function(){s.click()}),s.append('<li style="width:1px">&nbsp;</li>');var d='<li><div class="tag-editor-spacer">&nbsp;'+l.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>';s.click(function(t,i){var a,n,r=99999;if(!window.getSelection||""==getSelection())return l.maxTags&&s.data("tags").length>=l.maxTags?(s.find("input").blur(),!1):(o=!0,e("input:focus",s).blur(),!!o&&(o=!0,e(".placeholder",s).remove(),i&&i.length?n="before":e(".tag-editor-tag",s).each(function(){var o=e(this),l=o.offset(),c=l.left,s=l.top;t.pageY>=s&&t.pageY<=s+o.height()&&(t.pageX<c?(n="before",a=c-t.pageX):(n="after",a=t.pageX-c-o.width()),r>a&&(r=a,i=o))}),"before"==n?e(d).insertBefore(i.closest("li")).find(".tag-editor-tag").click():"after"==n?e(d).insertAfter(i.closest("li")).find(".tag-editor-tag").click():e(d).appendTo(s).find(".tag-editor-tag").click(),!1))}),s.on("click",".tag-editor-delete",function(){if(e(this).prev().hasClass("active"))return e(this).closest("li").find("input").caret(-1),!1;var a=e(this).closest("li"),r=a.find(".tag-editor-tag");return l.beforeTagDelete(n,s,c,r.text())!==!1&&(r.addClass("deleted").animate({width:0},l.animateDelete,function(){a.remove(),t()}),i(),!1)}),l.clickDelete&&s.on("mousedown",".tag-editor-tag",function(a){if(a.ctrlKey||a.which>1){var r=e(this).closest("li"),o=r.find(".tag-editor-tag");return l.beforeTagDelete(n,s,c,o.text())!==!1&&(o.addClass("deleted").animate({width:0},l.animateDelete,function(){r.remove(),t()}),i(),!1)}}),s.on("click",".tag-editor-tag",function(t){if(l.clickDelete&&(t.ctrlKey||t.which>1))return!1;if(!e(this).hasClass("active")){var i=e(this).text(),a=Math.abs((e(this).offset().left-t.pageX)/e(this).width()),n=parseInt(i.length*a),o=e(this).html('<input type="text" maxlength="'+l.maxLength+'" value="'+r(i)+'">').addClass("active").find("input");if(o.data("old_tag",i).tagEditorInput().focus().caret(n),l.autocomplete){var c=e.extend({},l.autocomplete),d="select"in c?l.autocomplete.select:"";c.select=function(t,i){d&&d(t,i),setTimeout(function(){s.trigger("click",[e(".active",s).find("input").closest("li").next("li").find(".tag-editor-tag")])},20)},o.autocomplete(c)}}return!1}),s.on("blur","input",function(d){d.stopPropagation();var g=e(this),f=g.data("old_tag"),u=e.trim(g.val().replace(/ +/," ").replace(l.dregex,l.delimiter[0]));if(u){if(u.indexOf(l.delimiter[0])>=0)return void a(g);if(u!=f)if(l.forceLowercase&&(u=u.toLowerCase()),cb_val=l.beforeTagSave(n,s,c,f,u),u=cb_val||u,cb_val===!1){if(f)return g.val(f).focus(),o=!1,void i();try{g.closest("li").remove()}catch(d){}f&&i()}else l.removeDuplicates&&e(".tag-editor-tag:not(.active)",s).each(function(){e(this).text()==u&&e(this).closest("li").remove()})}else{if(f&&l.beforeTagDelete(n,s,c,f)===!1)return g.val(f).focus(),o=!1,void i();try{g.closest("li").remove()}catch(d){}f&&i()}g.parent().html(r(u)).removeClass("active"),u!=f&&i(),t()});var g;s.on("paste","input",function(){e(this).removeAttr("maxlength"),g=e(this),setTimeout(function(){a(g)},30)});var f;s.on("keypress","input",function(t){l.delimiter.indexOf(String.fromCharCode(t.which))>=0&&(f=e(this),setTimeout(function(){a(f)},20))}),s.on("keydown","input",function(t){var i=e(this);if((37==t.which||!l.autocomplete&&38==t.which)&&!i.caret()||8==t.which&&!i.val()){var a=i.closest("li").prev("li").find(".tag-editor-tag");return a.length?a.click().find("input").caret(-1):!i.val()||l.maxTags&&s.data("tags").length>=l.maxTags||e(d).insertBefore(i.closest("li")).find(".tag-editor-tag").click(),!1}if((39==t.which||!l.autocomplete&&40==t.which)&&i.caret()==i.val().length){var r=i.closest("li").next("li").find(".tag-editor-tag");return r.length?r.click().find("input").caret(0):i.val()&&s.click(),!1}if(9==t.which){if(t.shiftKey){var a=i.closest("li").prev("li").find(".tag-editor-tag");if(a.length)a.click().find("input").caret(0);else{if(!i.val()||l.maxTags&&s.data("tags").length>=l.maxTags)return n.attr("disabled","disabled"),void setTimeout(function(){n.removeAttr("disabled")},30);e(d).insertBefore(i.closest("li")).find(".tag-editor-tag").click()}return!1}var r=i.closest("li").next("li").find(".tag-editor-tag");if(r.length)r.click().find("input").caret(0);else{if(!i.val())return;s.click()}return!1}if(!(46!=t.which||e.trim(i.val())&&i.caret()!=i.val().length)){var r=i.closest("li").next("li").find(".tag-editor-tag");return r.length?r.click().find("input").caret(0):i.val()&&s.click(),!1}if(13==t.which)return s.trigger("click",[i.closest("li").next("li").find(".tag-editor-tag")]),l.maxTags&&s.data("tags").length>=l.maxTags&&s.find("input").blur(),!1;if(36!=t.which||i.caret()){if(35==t.which&&i.caret()==i.val().length)s.find(".tag-editor-tag").last().click();else if(27==t.which)return i.val(i.data("old_tag")?i.data("old_tag"):"").blur(),!1}else s.find(".tag-editor-tag").first().click()});for(var u=l.initialTags.length?l.initialTags:n.val().split(l.dregex),h=0;h<u.length&&!(l.maxTags&&h>=l.maxTags);h++){var v=e.trim(u[h].replace(/ +/," "));v&&(l.forceLowercase&&(v=v.toLowerCase()),c.push(v),s.append('<li><div class="tag-editor-spacer">&nbsp;'+l.delimiter[0]+'</div><div class="tag-editor-tag">'+r(v)+'</div><div class="tag-editor-delete"><i></i></div></li>'))}i(!0),l.sortable&&e.fn.sortable&&s.sortable({distance:5,cancel:".tag-editor-spacer, input",helper:"clone",update:function(){i()}})})},e.fn.tagEditor.defaults={initialTags:[],maxTags:0,maxLength:50,delimiter:",;",placeholder:"",forceLowercase:!0,removeDuplicates:!0,clickDelete:!1,animateDelete:175,sortable:!0,autocomplete:null,onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){}}}(jQuery);